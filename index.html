<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Second Brain — SPA (Liquid Glass)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">
<style>
/* =========================
   Tokens & Reset
   ========================= */
:root{
  --bg-1: #0f1226;
  --bg-2: #151a38;
  --glass-card: rgba(255,255,255,0.08);
  --glass-border: rgba(255,255,255,0.12);
  --glass-edge: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  --primary: #7C9CFF;
  --success: #34D399;
  --warning: #F59E0B;
  --danger: #EF4444;
  --text-strong: rgba(255,255,255,0.92);
  --text: rgba(255,255,255,0.8);
  --text-muted: rgba(255,255,255,0.6);
  --radius-card: 16px;
  --radius-modal: 28px;
  --shadow: 0 10px 30px rgba(0,0,0,0.25);
  --glass-blur: 20px;
  --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:24px; --space-6:32px;
  --transition: 200ms cubic-bezier(.2,.9,.25,1);
  --max-width: 1200px;
  --mobile-break:480px; --tablet-break:1024px;
  --app-key: 'secondBrain.v1';
  --font-sans: Inter, "Helvetica Neue", Arial, sans-serif;
}

/* Reset */
*{box-sizing:border-box}
html,body,#app{height:100%}
body{
  margin:0;
  font-family:var(--font-sans);
  background:linear-gradient(135deg,var(--bg-1) 0%,var(--bg-2) 100%);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent;
  overflow:hidden;
}

/* subtle noise layer */
body::after{
  content:"";
  pointer-events:none;
  position:fixed;inset:0;
  background-image:radial-gradient(rgba(255,255,255,0.01) 1px, transparent 1px);
  background-size:3px 3px;
  mix-blend-mode:overlay;
  opacity:0.6;
}

/* App container */
.app {
  height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:var(--space-4);
  padding:var(--space-4);
}

/* Main area */
.container {
  width:100%;
  max-width:var(--max-width);
  flex:1 1 auto;
  display:flex;
  gap:var(--space-4);
}

/* Content area that will hold pages */
.main {
  flex:1 1 auto;
  display:flex;
  flex-direction:column;
  gap:var(--space-4);
  min-height:0; /* for overflow */
}

/* Header */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:var(--space-4);
  width:100%;
}
.brand {
  display:flex;align-items:center;gap:12px;
}
.logo {
  width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary), #9AD1FF);
  display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);
  font-weight:700;color:#06203b;
}
.title {
  font-size:18px;color:var(--text-strong);font-weight:600;
}
.header-actions {display:flex;gap:8px;align-items:center}

/* Glass card */
.glass {
  background:var(--glass-card);
  border-radius:var(--radius-card);
  border:1px solid var(--glass-border);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  box-shadow:var(--shadow);
  padding:var(--space-4);
  color:var(--text);
  transition:transform var(--transition), box-shadow var(--transition), opacity var(--transition);
}

/* card layout grid */
.card-grid {
  display:grid;
  gap:var(--space-4);
}
/* responsive columns */
@media (max-width:480px){
  .card-grid { grid-template-columns:1fr; }
  .app { padding:12px; }
}
@media (min-width:481px) and (max-width:1024px){
  .card-grid { grid-template-columns: repeat(2,1fr); }
}
@media (min-width:1025px){
  .card-grid { grid-template-columns: repeat(3,1fr); }
}

/* Card header */
.card {
  display:flex;flex-direction:column;gap:8px;
  min-height:80px;
  position:relative;
}
.card .card-header{
  display:flex;justify-content:space-between;align-items:center;gap:8px;
}
.card h3{margin:0;color:var(--text-strong);font-size:15px}
.card p{margin:0;color:var(--text);font-size:13px}

/* small elements */
.small{font-size:12px;color:var(--text-muted)}

/* Buttons */
.btn {
  background:transparent;border:0;color:var(--text);padding:8px;border-radius:10px;cursor:pointer;
}
.btn.primary{
  background:linear-gradient(90deg,var(--primary), #9AD1FF);
  color:#06203b;font-weight:600;padding:8px 12px;
  box-shadow:0 6px 18px rgba(124,156,255,0.12);border:1px solid rgba(255,255,255,0.06);
}
.btn.ghost{border:1px solid rgba(255,255,255,0.06);padding:6px 10px;}
.btn.icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;padding:0}

/* bottom nav (mobile) */
.bottom-nav {
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:14px;display:flex;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:999px;padding:8px;border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(12px);
  z-index:60;
}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 12px;border-radius:12px;color:var(--text-muted);cursor:pointer}
.nav-item.active{color:var(--text-strong);box-shadow:0 6px 18px rgba(124,156,255,0.12);background:linear-gradient(90deg, rgba(124,156,255,0.08), rgba(122,144,255,0.02));border:1px solid rgba(124,156,255,0.12)}

/* side nav for desktop (optional) */
.side-nav { display:none; flex-direction:column; gap:12px; width:220px; }
@media(min-width:1025px){
  .bottom-nav{ display:none; }
  .container { align-items:flex-start; }
  .side-nav { display:flex; position:sticky; top:24px; height:calc(100vh - 120px); }
}

/* Modal (panel) */
.modal-backdrop {
  position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:80;
}
.modal {
  width:min(920px,95%);max-height:90vh;overflow:auto;background:var(--glass-card);
  border-radius:var(--radius-modal);padding:20px;border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 20px 40px rgba(0,0,0,0.5);
}
.form-row{display:flex;gap:12px;flex-wrap:wrap}
.input,textarea,select{
  background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:var(--text);
  min-width:0;outline:none;
}
textarea{min-height:100px;resize:vertical}
.label{font-size:12px;color:var(--text-muted);margin-bottom:6px}
.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* Toasts */
.toasts{position:fixed;right:18px;top:18px;display:flex;flex-direction:column;gap:8px;z-index:90}
.toast{background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.02));padding:10px 14px;border-radius:10px;color:var(--text);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.06)}

/* Empty state */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;border-radius:12px;gap:12px;text-align:center;color:var(--text-muted)}

/* small utility */
.row{display:flex;gap:8px;align-items:center}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:999px;font-size:12px;color:var(--text-muted)}

/* Progress bar */
.progress{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
.progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary), #9AD1FF)}

/* small helpers */
.muted{color:var(--text-muted)}
.badge{background:rgba(255,255,255,0.04);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--text-muted)}

/* accessibility focus */
:focus{outline:2px solid rgba(124,156,255,0.28);outline-offset:2px;border-radius:8px}

/* tiny animations */
.fade-enter{opacity:0;transform:translateY(6px)}
.fade-enter-active{opacity:1;transform:none;transition:all var(--transition)}
.fade-exit{opacity:1}
.fade-exit-active{opacity:0;transition:opacity var(--transition)}
</style>
</head>
<body>
<div id="app" class="app" aria-live="polite">
  <div class="container">
    <nav class="side-nav glass" aria-label="Navegação principal" role="navigation"></nav>
    <main class="main" id="main" role="main" tabindex="-1">
      <header class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true">SB</div>
          <div>
            <div class="title">Second Brain</div>
            <div class="small muted">Centralize suas ideias, estudos, tarefas, dieta e finanças</div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn ghost" id="btn-import">Importar</button>
          <button class="btn ghost" id="btn-export">Exportar</button>
          <button class="btn ghost" id="btn-reset">Reset</button>
          <button class="btn" id="btn-toggle-theme" aria-pressed="false" title="Alternar tema">Tema</button>
        </div>
      </header>

      <!-- dynamic content -->
      <section id="page" class="card-grid" aria-live="polite"></section>

      <!-- bottom nav for mobile -->
    </main>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav" role="tablist" aria-label="Navegação principal" id="bottomNav"></nav>

  <!-- Modal container -->
  <div id="modal-root" aria-hidden="true"></div>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Invisible file input for import -->
  <input id="file-input" type="file" accept="application/json" style="display:none" />

  <!-- fallback note -->
  <div style="position:fixed;left:18px;bottom:18px;color:var(--text-muted);font-size:12px">SPA Hash Router • LocalStorage</div>
</div>

<!-- Chart.js CDN (optional) -->
<script>
/*
  index.html - Single File SPA Second Brain (Liquid Glass)
  - Implementa roteador hash, store com pub/sub e persistência, páginas, cards, modais, import/export, toasts
  - Comentários onde trechos críticos: roteador, store, renderização, persistência
*/

(function(){
  'use strict';

  /* =========================
     Utilities
     ========================= */
  const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,9);
  const q = (sel, el=document) => el.querySelector(sel);
  const qa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const clamp = (v,min,max) => Math.max(min,Math.min(max,v));
  const now = () => performance && performance.now ? performance.now() : Date.now();

  // debounce for search
  function debounce(fn, wait=250){
    let t;
    return function(...args){
      clearTimeout(t);
      t = setTimeout(()=>fn.apply(this,args), wait);
    }
  }

  // safe parse JSON
  function safeParse(json){ try{return JSON.parse(json)}catch(e){return null} }

  // download helper (export)
  function downloadJSON(filename, obj){
    try{
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename || 'backup.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast('Exportado com sucesso', 'success');
    }catch(e){ toast('Erro exportando: '+e.message, 'danger') }
  }

  /* =========================
     Schema definitions (Plan)
     ========================= */
  const schema = {
    meta: { version: 1, createdAt: null },
    config: {
      theme:'dark',
      autoSave:false
    },
    studies: [], // tópicos
    tasks: [], // planejamento
    diet: { meta: { kcalGoal:2200, macros:{p:30,c:40,f:30} }, days: {} },
    finance: { accounts:[], entries:[] }
  };

  // Example shapes:
  // study: {id,title,area,progress,tags[],nextDate(iso),links[],notes}
  // task: {id,title,desc,priority,status,deadline,tags[],subtasks[]}
  // meal entry stored in diet.days['2025-08-16'] => {meals:{breakfast:[],lunch:[],dinner:[],snacks:[]}, totals:{kcal,p,c,f}}
  // finance.entry: {id,type,category,amount,date,account,note}

  /* =========================
     Store (singleton) with pub/sub + persistence
     ========================= */
  const STORE_KEY = 'secondBrain.v1';
  const store = (function(){
    let state = JSON.parse(JSON.stringify(schema));
    let listeners = [];

    function subscribe(fn){ listeners.push(fn); return ()=> listeners = listeners.filter(l=>l!==fn) }
    function emit(){ listeners.forEach(fn=>{ try{fn(state)}catch(e){console.error(e)} }) }

    function load(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) {
          // populate mock if first time
          initMock();
          save();
          return;
        }
        const parsed = JSON.parse(raw);
        // migration placeholder: if parsed.meta.version < current -> migrate
        if(!parsed.meta || parsed.meta.version !== schema.meta.version){
          parsed.meta = parsed.meta || {};
          parsed.meta.version = schema.meta.version;
        }
        state = Object.assign(JSON.parse(JSON.stringify(schema)), parsed);
      }catch(e){
        console.error('Load failed', e);
        toast('Erro carregando dados do storage — reset automático', 'danger');
        resetToFactory();
      }
    }

    function save(){
      try{
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
        emit();
      }catch(e){ console.error('Save failed', e); toast('Erro salvando localStorage', 'danger') }
    }

    function resetToFactory(){
      state = JSON.parse(JSON.stringify(schema));
      initMock();
      save();
      toast('Dados restaurados para fábrica', 'success');
    }

    function get(){ return state }
    function set(patch, opts={save:true}){
      state = Object.assign({}, state, patch);
      if(opts.save !== false) save();
      emit();
    }

    function update(path, cb){
      // path like 'studies' or 'diet.days.2025-08-16'
      const keys = path.split('.');
      let cur = state;
      for(let i=0;i<keys.length-1;i++){
        cur = cur[keys[i]];
        if(cur===undefined) return;
      }
      const last = keys[keys.length-1];
      try{
        cur[last] = cb(cur[last]);
        save();
        emit();
      }catch(e){console.error(e)}
    }

    // public api
    return { load, save, get, set, subscribe, update, resetToFactory };
  })();

  /* =========================
     Mock Data (initial seed)
     ========================= */
  function initMock(){
    const today = new Date();
    function iso(offset=0){
      const d = new Date(today); d.setDate(d.getDate()+offset); return d.toISOString().slice(0,10);
    }
    const studies = [
      {id:uid('s'), title: "JavaScript Assíncrono", area:"Programação", progress:40, tags:["javascript","async"], nextDate:iso(1), links:["https://developer.mozilla.org"], notes:"Revisar Promises e async/await."},
      {id:uid('s'), title: "Redes Neurais Básicas", area:"ML", progress:20, tags:["ml","nn"], nextDate:iso(3), links:[], notes:"Ler capítulo 2 do livro."},
      {id:uid('s'), title: "Design de APIs REST", area:"Arquitetura", progress:60, tags:["api","rest"], nextDate:iso(2), links:[], notes:"Padronizar retorno de erros."},
      {id:uid('s'), title: "Matemática Discreta", area:"Matemática", progress:15, tags:["math"], nextDate:iso(7), links:[], notes:"Teorema dos grafos."},
      {id:uid('s'), title: "UX Writing", area:"Design", progress:80, tags:["ux","writing"], nextDate:iso(0), links:[], notes:"Checklist para microcopy."},
      {id:uid('s'), title: "SQL Avançado", area:"Dados", progress:50, tags:["sql","database"], nextDate:iso(4), links:[], notes:"Optimizar queries grandes."}
    ];

    const tasks = [];
    const statuses = ['Backlog','Em Andamento','Concluído'];
    const priorities = ['Baixa','Média','Alta'];
    for(let i=0;i<10;i++){
      tasks.push({
        id:uid('t'),
        title:`Tarefa exemplo ${i+1}`,
        desc:`Descrição da tarefa ${i+1}`,
        priority: priorities[i%3],
        status: statuses[i%3],
        deadline: iso(i%5),
        tags: [i%2? 'roteiro':'urgente'],
        subtasks: i%2 ? [{id:uid('st'),title:'Subtask 1',done:false}]:[]
      });
    }

    const diet = {
      meta: { kcalGoal:2200, macros:{p:30,c:40,f:30} },
      days: {}
    };
    // fill one day
    diet.days[iso(0)] = {
      meals:{
        breakfast:[{id:uid('m'),name:'Ovos mexidos',portion:'2 ovos',kcal:180,p:12,c:1,f:14}],
        lunch:[{id:uid('m'),name:'Arroz + Frango',portion:'200g',kcal:650,p:40,c:70,f:10}],
        dinner:[{id:uid('m'),name:'Salada + Salmão',portion:'180g',kcal:520,p:35,c:10,f:35}],
        snacks:[{id:uid('m'),name:'Iogurte',portion:'150g',kcal:120,p:8,c:10,f:4}]
      }
    };

    const finance = { accounts:['Conta Corrente'], entries:[] };
    const categories = ['Alimentação','Moradia','Lazer','Transporte','Salário'];
    // create 10 entries
    for(let i=0;i<10;i++){
      finance.entries.push({
        id:uid('f'),
        type: i<2 ? 'receita' : 'despesa',
        category: i<2 ? 'Salário' : categories[(i%4)],
        amount: +( (i<2?2000: (20+Math.random()*200)).toFixed(2) ),
        date: iso(-i%30),
        account: 'Conta Corrente',
        note: i<2 ? 'Recebimento mensal' : 'Despesa teste'
      });
    }

    const cfg = { theme:'dark', autoSave:false };

    const data = {
      meta: { version: schema.meta.version, createdAt: new Date().toISOString() },
      config: cfg,
      studies, tasks, diet, finance
    };

    // set into store state directly
    store.set(data);
  }

  /* =========================
     Router (hash-based)
     - highlights active tab and lazy renders pages
     ========================= */
  const ROUTES = [
    {path:'#/dashboard', name:'Início', id:'dashboard', icon:'🏠'},
    {path:'#/estudos', name:'Estudos', id:'estudos', icon:'📚'},
    {path:'#/planejamento', name:'Planejamento', id:'planejamento', icon:'🗂️'},
    {path:'#/dieta', name:'Dieta', id:'dieta', icon:'🍽️'},
    {path:'#/financas', name:'Finanças', id:'financas', icon:'💰'}
  ];

  function getRoute(){
    const h = location.hash || '#/dashboard';
    const r = ROUTES.find(r=>r.path===h) || ROUTES[0];
    return r;
  }

  // setup nav UI (bottom + side)
  function renderNav(){
    const bottom = q('#bottomNav');
    bottom.innerHTML = '';
    ROUTES.forEach(route=>{
      const btn = document.createElement('button');
      btn.className = 'nav-item';
      btn.setAttribute('role','tab');
      btn.setAttribute('aria-label',route.name);
      btn.dataset.path = route.path;
      btn.tabIndex = 0;
      btn.innerHTML = `<div style="font-size:18px">${route.icon}</div><div style="font-size:12px">${route.name}</div>`;
      btn.addEventListener('click', ()=> { navigate(route.path) });
      bottom.appendChild(btn);
    });

    // side nav for desktop
    const side = q('.side-nav');
    side.innerHTML = '';
    ROUTES.forEach(route=>{
      const a = document.createElement('button');
      a.className = 'nav-item';
      a.style.width='100%';
      a.dataset.path = route.path;
      a.innerHTML = `<div style="font-size:18px">${route.icon}</div><div style="font-size:12px">${route.name}</div>`;
      a.addEventListener('click', ()=> navigate(route.path));
      side.appendChild(a);
    });

    highlightActiveTab();
  }

  function highlightActiveTab(){
    const route = getRoute();
    qa('.nav-item').forEach(el=>{
      el.classList.toggle('active', el.dataset.path === route.path);
      el.setAttribute('aria-selected', el.dataset.path === route.path ? 'true':'false');
    });
  }

  function navigate(path){
    if(location.hash !== path) location.hash = path;
    else renderRoute(); // same hash click
  }

  window.addEventListener('hashchange', ()=> renderRoute());

  /* =========================
     Modal component (reusable)
     - focus trap basic, Esc to close, ARIA
     ========================= */
  function openModal({title='Editar', content=null, onSave=null, width='min(920px,95%)', ariaLabel='Modal'}){
    const root = q('#modal-root');
    root.innerHTML = '';
    root.setAttribute('aria-hidden','false');

    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade-enter';
    backdrop.tabIndex = -1;
    backdrop.addEventListener('click', (e)=> { if(e.target===backdrop) close() });

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.width = width;
    modal.setAttribute('role','dialog');
    modal.setAttribute('aria-label', ariaLabel);
    modal.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
        <div>
          <h2 style="margin:0;color:var(--text-strong);font-size:16px">${title}</h2>
          <div class="small muted">Editar e salvar alterações</div>
        </div>
        <div class="row">
          <button class="btn" id="modal-dup" title="Duplicar">Duplicar</button>
          <button class="btn" id="modal-del" title="Excluir">Excluir</button>
          <button class="btn" id="modal-close" aria-label="Fechar (Esc)">✖</button>
        </div>
      </div>
      <div id="modal-body"></div>
      <div class="form-actions">
        <button class="btn" id="modal-cancel">Cancelar</button>
        <button class="btn primary" id="modal-save">Salvar</button>
      </div>
    `;
    backdrop.appendChild(modal);
    root.appendChild(backdrop);

    const body = q('#modal-body');
    if(typeof content === 'string') body.innerHTML = content;
    else if(content instanceof Node) body.appendChild(content);

    // handlers
    q('#modal-close').addEventListener('click', close);
    q('#modal-cancel').addEventListener('click', close);
    q('#modal-save').addEventListener('click', ()=> {
      if(onSave) {
        try{ onSave() }catch(e){ console.error(e); toast('Erro salvando: '+e.message,'danger'); return; }
      }
      close();
    });
    q('#modal-del').addEventListener('click', ()=> {
      const ev = new CustomEvent('modal:delete', {detail:{}});
      modal.dispatchEvent(ev);
    });
    q('#modal-dup').addEventListener('click', ()=> {
      const ev = new CustomEvent('modal:duplicate', {detail:{}});
      modal.dispatchEvent(ev);
    });

    // keyboard
    function onKey(e){
      if(e.key === 'Escape') close();
    }
    document.addEventListener('keydown', onKey);

    // focus first input
    setTimeout(()=> {
      const input = modal.querySelector('input,textarea,button,select');
      if(input) input.focus();
    },50);

    function close(){
      root.innerHTML = '';
      root.setAttribute('aria-hidden','true');
      document.removeEventListener('keydown', onKey);
    }

    return { modal, close, backdrop };
  }

  /* =========================
     Toast system
     ========================= */
  const toastQueue = [];
  function toast(msg, type='info', ttl=3500){
    const troot = q('#toasts');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<strong style="display:block">${msg}</strong>`;
    troot.appendChild(el);
    setTimeout(()=> {
      el.style.transition = 'opacity 300ms'; el.style.opacity = '0';
      setTimeout(()=> el.remove(), 320);
    }, ttl);
  }

  /* =========================
     Components: Card renderer helpers
     ========================= */
  function createCard({title,subtitle,body,footer, clickable=true, onClick=null, actions=[] }){
    const el = document.createElement('article');
    el.className = 'glass card';
    const header = document.createElement('div'); header.className='card-header';
    header.innerHTML = `<div><h3>${title}</h3><div class="small muted">${subtitle||''}</div></div>`;
    const actionWrap = document.createElement('div'); actionWrap.className='row';
    actions.forEach(a=>{
      const btn = document.createElement('button'); btn.className='btn icon'; btn.title=a.title || '';
      btn.innerHTML = a.icon || '⋯'; btn.addEventListener('click', (e)=>{ e.stopPropagation(); a.onClick && a.onClick(e) });
      actionWrap.appendChild(btn);
    });
    header.appendChild(actionWrap);
    el.appendChild(header);
    if(body){
      const b = document.createElement('div'); b.innerHTML = body; el.appendChild(b);
    }
    if(footer){
      const f = document.createElement('div'); f.className='small muted'; f.innerHTML = footer; el.appendChild(f);
    }
    if(clickable && onClick){
      el.style.cursor='pointer';
      el.addEventListener('click', ()=> onClick());
    }
    return el;
  }

  /* =========================
     Page Renderers (lazy)
     - Each render* will build DOM into #page
     - Use store.get() to compute
     ========================= */

  // Dashboard - cards + charts + quick actions
  function renderDashboard(){
    const page = q('#page');
    page.innerHTML = '';
    page.className = 'card-grid';
    page.style.gridTemplateColumns = 'repeat(auto-fit,minmax(240px,1fr))';

    const s = store.get();

    // Resumo do Dia card
    const today = new Date().toISOString().slice(0,10);
    const studiesToday = s.studies.filter(st=> st.nextDate === today);
    const pendingTasks = s.tasks.filter(t=> t.status !== 'Concluído').length;

    const resumo = createCard({
      title:'Resumo do Dia',
      subtitle: new Date().toLocaleDateString(),
      body: `<div class="small">Estudos com prazo: <strong>${studiesToday.length}</strong></div>
             <div class="small">Tarefas pendentes: <strong>${pendingTasks}</strong></div>
             <div style="margin-top:8px" class="row">
               <button class="btn primary" id="quick-task">+ Nova Tarefa</button>
               <button class="btn" id="quick-meal">+ Nova Refeição</button>
               <button class="btn" id="quick-fin">+ Lançamento</button>
             </div>`,
      footer: 'Ações rápidas'
    });
    page.appendChild(resumo);

    // Progresso de Estudos (card com progress)
    const avgProgress = s.studies.length? Math.round(s.studies.reduce((a,b)=>a+b.progress,0)/s.studies.length):0;
    const progCard = createCard({
      title:'Progresso de Estudos',
      subtitle:`Média: ${avgProgress}%`,
      body: `<div class="progress" aria-valuenow="${avgProgress}" role="progressbar" aria-label="Progresso de estudos"><i style="width:${avgProgress}%"></i></div>
             <div style="margin-top:8px" class="small">${s.studies.length} tópicos</div>`,
      actions:[{icon:'🔍',title:'Ver Estudos', onClick:()=> navigate('#/estudos')}]
    });
    page.appendChild(progCard);

    // Tarefas Pendentes
    const tasksCard = createCard({
      title:'Tarefas Pendentes',
      subtitle:`${pendingTasks} não concluídas`,
      body: s.tasks.slice(0,5).map(t=> `<div style="display:flex;justify-content:space-between"><div><strong>${t.title}</strong><div class="small muted">${t.priority} • ${t.deadline||'sem prazo'}</div></div><div class="small">${t.status}</div></div>`).join('<hr style="opacity:0.06;margin:8px 0">'),
      actions:[{icon:'➕',title:'Nova Tarefa', onClick:()=> openTaskModal()}]
    });
    page.appendChild(tasksCard);

    // Status da Dieta
    const dietCard = createCard({
      title:'Status da Dieta',
      subtitle:`Meta: ${s.diet.meta.kcalGoal} kcal`,
      body: (() => {
        const day = s.diet.days[today] || {meals:{}, totals:{kcal:0}};
        const totals = {kcal:0,p:0,c:0,f:0};
        if(day.meals){
          Object.values(day.meals).flat().forEach(it => { if(it){ totals.kcal += (it.kcal||0); totals.p += (it.p||0); totals.c += (it.c||0); totals.f += (it.f||0) }});
        }
        const pct = Math.round((totals.kcal / s.diet.meta.kcalGoal) * 100);
        return `<div class="small">Hoje: <strong>${totals.kcal} kcal</strong> (${pct}%)</div>
                <div style="margin-top:8px" class="progress"><i style="width:${clamp(pct,0,100)}%"></i></div>`;
      })(),
      actions:[{icon:'🍽️',title:'Ir para Dieta', onClick:()=> navigate('#/dieta')}]
    });
    page.appendChild(dietCard);

    // Resumo Financeiro
    const finCard = createCard({
      title:'Resumo Financeiro',
      subtitle:'Mês atual',
      body: (()=> {
        const entries = s.finance.entries || [];
        const thisMonth = new Date().getMonth();
        const monthEntries = entries.filter(e=> new Date(e.date).getMonth() === thisMonth);
        const income = monthEntries.filter(e=> e.type==='receita').reduce((a,b)=>a+b.amount,0);
        const expenses = monthEntries.filter(e=> e.type==='despesa').reduce((a,b)=>a+b.amount,0);
        return `<div class="small">Receitas: <strong>R$ ${income.toFixed(2)}</strong></div>
                <div class="small">Despesas: <strong>R$ ${expenses.toFixed(2)}</strong></div>
                <div style="margin-top:8px" class="small">Saldo: <strong>R$ ${(income-expenses).toFixed(2)}</strong></div>`;
      })(),
      actions:[{icon:'💳',title:'Ir para Finanças', onClick:()=> navigate('#/financas')}]
    });
    page.appendChild(finCard);

    // Charts (using Chart.js if available)
    const chartsArea = document.createElement('div'); chartsArea.style.gridColumn = '1 / -1';
    chartsArea.className = 'glass';
    chartsArea.innerHTML = `<div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px"><canvas id="chart-study" height="120"></canvas><div class="small muted">Horas de estudo (7 dias)</div></div>
      <div style="flex:1;min-width:220px"><canvas id="chart-tasks" height="120"></canvas><div class="small muted">Tarefas concluídas por semana</div></div>
      <div style="flex:1;min-width:220px"><canvas id="chart-macro" height="120"></canvas><div class="small muted">Macros (%)</div></div>
    </div>`;
    page.appendChild(chartsArea);

    // quick action bindings
    q('#quick-task').addEventListener('click', ()=> openTaskModal());
    q('#quick-meal').addEventListener('click', ()=> openMealModal());
    q('#quick-fin').addEventListener('click', ()=> openFinanceModal());

    // render charts safely
    renderChartsDashboard(s);
  }

  // render chart helper
  function renderChartsDashboard(state){
    // attempt to load Chart if available
    const loadChart = window.Chart;
    try{
      const studyCtx = q('#chart-study');
      const tasksCtx = q('#chart-tasks');
      const macroCtx = q('#chart-macro');

      // mock data: hours study last 7 days from studies progress (randomized)
      const labels = [];
      const studyData = [];
      for(let i=6;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate()-i);
        labels.push(d.toLocaleDateString());
        // base on studies progress average * small random
        const avg = state.studies.length? Math.round(state.studies.reduce((a,b)=>a+b.progress,0)/state.studies.length):20;
        studyData.push(Math.round(Math.max(0, (avg/20) + Math.random()*2 )));
      }

      // tasks completed per week (mock)
      const tasksData = [2,3,1,4,5,2,3];

      // macros Donut
      const macros = state.diet.meta.macros;
      const macroValues = [macros.p,macros.c,macros.f];

      if(loadChart){
        // destroy old charts if any
        if(window.__chartStudy) window.__chartStudy.destroy();
        if(window.__chartTasks) window.__chartTasks.destroy();
        if(window.__chartMacro) window.__chartMacro.destroy();

        window.__chartStudy = new Chart(studyCtx.getContext('2d'), {
          type:'line',
          data:{labels, datasets:[{label:'Horas', data:studyData, borderColor: 'rgba(124,156,255,0.9)', backgroundColor:'rgba(124,156,255,0.12)', tension:0.3}]},
          options:{plugins:{legend:{display:false}}, maintainAspectRatio:false}
        });

        window.__chartTasks = new Chart(tasksCtx.getContext('2d'), {
          type:'bar',
          data:{labels, datasets:[{label:'Concluídas', data:tasksData, backgroundColor:'rgba(124,156,255,0.9)'}]},
          options:{plugins:{legend:{display:false}}, maintainAspectRatio:false}
        });

        window.__chartMacro = new Chart(macroCtx.getContext('2d'), {
          type:'doughnut',
          data:{labels:['Proteína','Carboidratos','Gorduras'], datasets:[{data:macroValues, backgroundColor:['#7C9CFF','#34D399','#F59E0B']}]},
          options:{plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false}
        });
      } else {
        studyCtx.parentElement.innerHTML = `<div class="empty">Gráficos indisponíveis (Chart.js não carregado)</div>`;
      }
    }catch(e){
      console.error('Chart error', e);
    }
  }

  /* =========================
     Estudos Page
     - grid/list toggles, search with debounce, filters
     ========================= */
  function renderEstudos(){
    const page = q('#page');
    page.innerHTML = '';
    page.style.gridTemplateColumns = 'repeat(auto-fit,minmax(240px,1fr))';
    const s = store.get();

    // header controls
    const headerCard = document.createElement('div');
    headerCard.className = 'glass';
    headerCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h3 style="margin:0">Estudos</h3>
        <div class="small muted">Gerencie seus tópicos</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input aria-label="Pesquisar estudos" placeholder="Pesquisar..." id="search-studies" class="input" style="width:220px;background:transparent" />
        <select id="filter-tag" class="input"><option value="">Todos tags</option></select>
        <button class="btn primary" id="add-study">+ Adicionar</button>
      </div>
    </div>`;
    page.appendChild(headerCard);

    // populate tag filter
    const tagSet = new Set();
    s.studies.forEach(st => (st.tags||[]).forEach(t=>tagSet.add(t)));
    const filterTag = q('#filter-tag');
    tagSet.forEach(t => {
      const opt = document.createElement('option'); opt.value=t; opt.textContent=t; filterTag.appendChild(opt);
    });

    // container for cards
    const grid = document.createElement('div');
    grid.className = 'card-grid';
    grid.style.gridTemplateColumns = 'repeat(auto-fit,minmax(220px,1fr))';
    grid.style.width='100%';
    page.appendChild(grid);

    function buildCards(filterText='', tag=''){
      grid.innerHTML = '';
      const list = s.studies.filter(st=>{
        const matchesText = filterText ? (st.title.toLowerCase().includes(filterText) || (st.notes||'').toLowerCase().includes(filterText)) : true;
        const matchesTag = tag ? (st.tags||[]).includes(tag) : true;
        return matchesText && matchesTag;
      });
      if(list.length===0){
        const empty = document.createElement('div'); empty.className='empty';
        empty.innerHTML = `<div class="small">Nenhum tópico encontrado</div><button class="btn primary" id="empty-add">Adicionar tópico</button>`;
        grid.appendChild(empty);
        q('#empty-add').addEventListener('click', ()=> openStudyModal());
        return;
      }
      list.forEach(st=>{
        const body = `<div class="small muted">${st.area || ''}</div>
                      <div style="margin-top:8px" class="progress" aria-valuenow="${st.progress}"><i style="width:${st.progress}%"></i></div>
                      <div style="margin-top:8px" class="chips">${(st.tags||[]).map(t=>`<span class="chip">${t}</span>`).join('')}</div>
                      <div style="margin-top:8px" class="small muted">Próximo: ${st.nextDate||'—'}</div>`;
        const c = createCard({
          title:st.title, subtitle:st.area, body, onClick: ()=> openStudyModal(st)
        });
        grid.appendChild(c);
      });
    }

    buildCards();

    // handlers
    q('#add-study').addEventListener('click', ()=> openStudyModal());
    const searchInput = q('#search-studies');
    const deb = debounce(()=> buildCards(searchInput.value.toLowerCase(), filterTag.value), 300);
    searchInput.addEventListener('input', deb);
    filterTag.addEventListener('change', ()=> buildCards(searchInput.value.toLowerCase(), filterTag.value));
  }

  // Modal: add/edit study
  function openStudyModal(study){
    const isNew = !study;
    const s = store.get();
    const clone = study ? JSON.parse(JSON.stringify(study)) : {id:uid('s'), title:'', area:'', progress:0, tags:[], nextDate:'', links:[], notes:''};

    const content = document.createElement('div');
    content.innerHTML = `
      <div class="form-row">
        <div style="flex:1">
          <label class="label">Título</label>
          <input id="f-title" class="input" value="${escapeHtml(clone.title)}" />
        </div>
        <div style="width:160px">
          <label class="label">Área</label>
          <input id="f-area" class="input" value="${escapeHtml(clone.area||'')}" />
        </div>
      </div>
      <div class="form-row" style="margin-top:8px">
        <div style="flex:1">
          <label class="label">Tags (vírgula)</label>
          <input id="f-tags" class="input" value="${(clone.tags||[]).join(',')}" />
        </div>
        <div style="width:160px">
          <label class="label">Próxima data</label>
          <input id="f-date" type="date" class="input" value="${clone.nextDate||''}" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="label">Progresso: <span id="f-progress-val">${clone.progress||0}%</span></label>
        <input id="f-progress" type="range" min="0" max="100" value="${clone.progress||0}" />
      </div>
      <div style="margin-top:8px">
        <label class="label">Links (uma por linha)</label>
        <textarea id="f-links" class="input">${(clone.links||[]).join('\n')}</textarea>
      </div>
      <div style="margin-top:8px">
        <label class="label">Notas</label>
        <textarea id="f-notes" class="input">${escapeHtml(clone.notes||'')}</textarea>
      </div>
    `;

    const modal = openModal({
      title: isNew ? 'Novo Tópico' : 'Editar Tópico',
      content,
      ariaLabel: 'Editar tópico',
      onSave: ()=> {
        // validation simple
        const title = q('#f-title', content).value.trim();
        if(!title) { toast('Título obrigatório','warning'); return; }
        clone.title = title;
        clone.area = q('#f-area', content).value.trim();
        clone.tags = q('#f-tags', content).value.split(',').map(s=>s.trim()).filter(Boolean);
        clone.nextDate = q('#f-date', content).value || '';
        clone.progress = Number(q('#f-progress', content).value||0);
        clone.links = q('#f-links', content).value.split('\n').map(l=>l.trim()).filter(Boolean);
        clone.notes = q('#f-notes', content).value;
        // save to store
        const state = store.get();
        if(isNew){
          state.studies.unshift(clone);
        } else {
          const idx = state.studies.findIndex(x=>x.id===clone.id);
          if(idx>=0) state.studies[idx] = clone;
        }
        store.set(state);
        toast('Tópico salvo', 'success');
        renderEstudos();
      }
    });

    // wire progress display
    q('#f-progress', content).addEventListener('input', (e)=> {
      q('#f-progress-val', content).textContent = `${e.target.value}%`;
    });

    // modal events for delete/duplicate
    modal.modal.addEventListener('modal:delete', ()=>{
      if(!isNew && confirm('Excluir este tópico?')){
        const state = store.get();
        state.studies = state.studies.filter(x=>x.id!==clone.id);
        store.set(state);
        modal.close();
        renderEstudos();
        toast('Tópico excluído','success');
      }
    });
    modal.modal.addEventListener('modal:duplicate', ()=>{
      const state = store.get();
      const copy = JSON.parse(JSON.stringify(clone)); copy.id = uid('s'); copy.title += ' (cópia)';
      state.studies.unshift(copy);
      store.set(state);
      modal.close();
      renderEstudos();
      toast('Tópico duplicado','success');
    });
  }

  /* =========================
     Planejamento Page (tasks)
     - list + simple kanban (buttons to move)
     ========================= */
  function renderPlanejamento(){
    const p = q('#page'); p.innerHTML=''; p.style.gridTemplateColumns='repeat(auto-fit,minmax(240px,1fr))';
    const s = store.get();

    const header = document.createElement('div');
    header.className='glass';
    header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 style="margin:0">Planejamento</h3><div class="small muted">Tarefas e prioridades</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn primary" id="add-task">+ Nova Tarefa</button>
        <input id="search-tasks" class="input" placeholder="Pesquisar..." style="width:220px;background:transparent" />
      </div>
    </div>`;
    p.appendChild(header);

    const board = document.createElement('div');
    board.style.display='grid';
    board.style.gridTemplateColumns='repeat(3,1fr)';
    board.style.gap='12px';
    board.style.width='100%';
    p.appendChild(board);

    const statuses = ['Backlog','Em Andamento','Concluído'];

    function buildColumns(filterText=''){
      board.innerHTML='';
      statuses.forEach(status=>{
        const col = document.createElement('div');
        col.className='glass';
        col.innerHTML = `<h4 style="margin:0 0 8px 0">${status}</h4><div class="small muted">${s.tasks.filter(t=>t.status===status).length} tarefas</div>`;
        const list = document.createElement('div'); list.style.marginTop='12px'; list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px';
        s.tasks.filter(t=>t.status===status && (filterText? (t.title.toLowerCase().includes(filterText) || (t.desc||'').toLowerCase().includes(filterText)):true)).forEach(t=>{
          const tcard = document.createElement('div'); tcard.className='glass';
          tcard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${t.title}</strong><div class="small muted">${t.priority} • ${t.deadline||'sem prazo'}</div></div>
            <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
              <div class="small">${t.tags?.join(', ')||''}</div>
              <div style="display:flex;gap:6px">
                ${status!=='Backlog' ? `<button class="btn" data-action="move-left">◀</button>` : ''}
                ${status!=='Concluído' ? `<button class="btn" data-action="move-right">▶</button>` : ''}
                <button class="btn" data-action="edit">✎</button>
              </div>
            </div>
          </div>`;
          // button handlers
          tcard.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
              const a = btn.dataset.action;
              if(a==='move-right'){
                t.status = statuses[Math.min(2,statuses.indexOf(t.status)+1)];
                store.save && store.save();
                store.set(store.get()); // trigger
                buildColumns(filterText);
              } else if(a==='move-left'){
                t.status = statuses[Math.max(0,statuses.indexOf(t.status)-1)];
                store.set(store.get());
                buildColumns(filterText);
              } else if(a==='edit'){
                openTaskModal(t);
              }
            });
          });
          list.appendChild(tcard);
        });
        col.appendChild(list);
        board.appendChild(col);
      });
    }

    buildColumns();

    q('#add-task').addEventListener('click', ()=> openTaskModal());

    const searchTasks = q('#search-tasks');
    const deb = debounce(()=> buildColumns(searchTasks.value.toLowerCase()), 250);
    searchTasks.addEventListener('input', deb);
  }

  function openTaskModal(task){
    const isNew = !task;
    const clone = task ? JSON.parse(JSON.stringify(task)) : {id:uid('t'), title:'', desc:'', priority:'Média', status:'Backlog', deadline:'', tags:[],subtasks:[]};
    const content = document.createElement('div');
    content.innerHTML = `
      <div class="form-row">
        <div style="flex:1">
          <label class="label">Título</label>
          <input id="t-title" class="input" value="${escapeHtml(clone.title)}" />
        </div>
        <div style="width:140px">
          <label class="label">Prioridade</label>
          <select id="t-priority" class="input">
            <option ${clone.priority==='Baixa'?'selected':''}>Baixa</option>
            <option ${clone.priority==='Média'?'selected':''}>Média</option>
            <option ${clone.priority==='Alta'?'selected':''}>Alta</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="label">Descrição</label><textarea id="t-desc" class="input">${escapeHtml(clone.desc)}</textarea>
      </div>
      <div class="form-row" style="margin-top:8px">
        <div style="width:180px">
          <label class="label">Status</label>
          <select id="t-status" class="input">
            <option ${clone.status==='Backlog'?'selected':''}>Backlog</option>
            <option ${clone.status==='Em Andamento'?'selected':''}>Em Andamento</option>
            <option ${clone.status==='Concluído'?'selected':''}>Concluído</option>
          </select>
        </div>
        <div style="width:160px">
          <label class="label">Prazo</label>
          <input id="t-deadline" type="date" class="input" value="${clone.deadline||''}" />
        </div>
        <div style="flex:1">
          <label class="label">Tags (vírgula)</label>
          <input id="t-tags" class="input" value="${(clone.tags||[]).join(',')}" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="label">Subtarefas (uma por linha)</label>
        <textarea id="t-subtasks" class="input">${(clone.subtasks||[]).map(st=>st.title).join('\n')}</textarea>
      </div>
    `;
    const modal = openModal({
      title: isNew ? 'Nova Tarefa' : 'Editar Tarefa',
      content,
      ariaLabel:'Editar tarefa',
      onSave: ()=> {
        const title = q('#t-title', content).value.trim();
        if(!title){ toast('Título obrigatório','warning'); return; }
        clone.title = title;
        clone.desc = q('#t-desc', content).value;
        clone.priority = q('#t-priority', content).value;
        clone.status = q('#t-status', content).value;
        clone.deadline = q('#t-deadline', content).value || '';
        clone.tags = q('#t-tags', content).value.split(',').map(s=>s.trim()).filter(Boolean);
        clone.subtasks = q('#t-subtasks', content).value.split('\n').map(s=>({id:uid('st'),title:s.trim(),done:false})).filter(st=>st.title);
        const state = store.get();
        if(isNew) state.tasks.unshift(clone);
        else {
          const idx = state.tasks.findIndex(x=>x.id===clone.id);
          if(idx>=0) state.tasks[idx] = clone;
        }
        store.set(state);
        toast('Tarefa salva','success');
        renderPlanejamento();
      }
    });

    modal.modal.addEventListener('modal:delete', ()=>{
      if(!isNew && confirm('Excluir tarefa?')){
        const state = store.get();
        state.tasks = state.tasks.filter(x=>x.id!==clone.id);
        store.set(state);
        modal.close();
        renderPlanejamento();
        toast('Tarefa excluída','success');
      }
    });
    modal.modal.addEventListener('modal:duplicate', ()=>{
      const state = store.get();
      const c = JSON.parse(JSON.stringify(clone)); c.id = uid('t'); c.title += ' (cópia)';
      state.tasks.unshift(c);
      store.set(state);
      modal.close();
      renderPlanejamento();
      toast('Tarefa duplicada','success');
    });
  }

  /* =========================
     Dieta Page
     - days navigation, meals, totals vs meta
     ========================= */
  function renderDieta(){
    const p = q('#page'); p.innerHTML=''; p.style.gridTemplateColumns='repeat(auto-fit,minmax(240px,1fr))';
    const s = store.get();
    const today = new Date();
    let selected = today.toISOString().slice(0,10);

    const header = document.createElement('div'); header.className='glass';
    header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 style="margin:0">Dieta</h3><div class="small muted">Acompanhamento de refeições</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="prev-day">◀</button>
        <input id="day-select" type="date" class="input" value="${selected}" />
        <button class="btn" id="next-day">▶</button>
        <button class="btn primary" id="add-meal">+ Refeição</button>
      </div>
    </div>`;
    p.appendChild(header);

    const dayArea = document.createElement('div'); dayArea.style.width='100%';
    p.appendChild(dayArea);

    function buildDay(day){
      dayArea.innerHTML = '';
      const meta = s.diet.meta;
      const dayData = s.diet.days[day] || {meals:{breakfast:[],lunch:[],dinner:[],snacks:[]}};

      // totals
      const totals = {kcal:0,p:0,c:0,f:0};
      Object.values(dayData.meals).flat().forEach(it=>{
        if(it){ totals.kcal+=it.kcal||0; totals.p+=it.p||0; totals.c+=it.c||0; totals.f+=it.f||0 }
      });

      const totCard = createCard({
        title:`Totais ${day}`,
        subtitle:`Meta ${meta.kcalGoal} kcal`,
        body:`<div class="small">Kcal: <strong>${totals.kcal}</strong></div>
              <div class="small">P:${totals.p}g C:${totals.c}g F:${totals.f}g</div>
              <div style="margin-top:8px" class="small ${totals.kcal>meta.kcalGoal?'muted':'muted'}">${totals.kcal>meta.kcalGoal?'<strong style="color:var(--warning)">Excedeu a meta</strong>':'Dentro da meta'}</div>`,
        actions:[{icon:'🗓️',title:'Exportar', onClick: ()=> toast('Exportar dia (em breve)','info')}]
      });
      dayArea.appendChild(totCard);

      // meals list
      Object.entries(dayData.meals).forEach(([mealName, items])=>{
        const c = createCard({
          title: mealName[0].toUpperCase()+mealName.slice(1),
          subtitle: `${items.length} itens`,
          body: items.map(it=>`<div style="display:flex;justify-content:space-between"><div><strong>${it.name}</strong><div class="small muted">${it.portion}</div></div><div class="small">${it.kcal} kcal</div></div>`).join('<hr style="opacity:0.06;margin:8px 0">'),
          actions:[{icon:'➕',title:'Adicionar', onClick:()=> openMealItemModal(day, mealName)}]
        });
        dayArea.appendChild(c);
      });
    }

    buildDay(selected);

    // handlers
    q('#prev-day').addEventListener('click', ()=> {
      const d = new Date(selected); d.setDate(d.getDate()-1); selected = d.toISOString().slice(0,10); q('#day-select').value = selected; buildDay(selected);
    });
    q('#next-day').addEventListener('click', ()=> {
      const d = new Date(selected); d.setDate(d.getDate()+1); selected = d.toISOString().slice(0,10); q('#day-select').value = selected; buildDay(selected);
    });
    q('#day-select').addEventListener('change', (e)=> { selected = e.target.value; buildDay(selected); });
    q('#add-meal').addEventListener('click', ()=> openMealItemModal(selected,'lunch'));
  }

  function openMealModal(){
    // quick create new meal for today
    const today = new Date().toISOString().slice(0,10);
    openMealItemModal(today,'lunch');
  }

  function openMealItemModal(day, mealName){
    const s = store.get();
    const item = {id:uid('m'),name:'',portion:'',kcal:0,p:0,c:0,f:0};
    const content = document.createElement('div');
    content.innerHTML = `
      <div class="form-row">
        <div style="flex:1"><label class="label">Nome</label><input id="m-name" class="input" /></div>
        <div style="width:120px"><label class="label">Porção</label><input id="m-portion" class="input" /></div>
      </div>
      <div class="form-row" style="margin-top:8px">
        <div style="width:120px"><label class="label">Kcal</label><input id="m-kcal" type="number" class="input" value="0" /></div>
        <div style="width:120px"><label class="label">P(g)</label><input id="m-p" type="number" class="input" value="0" /></div>
        <div style="width:120px"><label class="label">C(g)</label><input id="m-c" type="number" class="input" value="0" /></div>
        <div style="width:120px"><label class="label">F(g)</label><input id="m-f" type="number" class="input" value="0" /></div>
      </div>
    `;
    const modal = openModal({
      title:`Adicionar item — ${mealName}`,
      content,
      ariaLabel:'Adicionar refeição',
      onSave: ()=> {
        item.name = q('#m-name',content).value.trim(); if(!item.name) { toast('Nome obrigatório','warning'); return; }
        item.portion = q('#m-portion',content).value.trim();
        item.kcal = Number(q('#m-kcal',content).value||0);
        item.p = Number(q('#m-p',content).value||0);
        item.c = Number(q('#m-c',content).value||0);
        item.f = Number(q('#m-f',content).value||0);
        const state = store.get();
        state.diet.days[day] = state.diet.days[day] || {meals:{breakfast:[],lunch:[],dinner:[],snacks:[]}};
        state.diet.days[day].meals[mealName] = state.diet.days[day].meals[mealName] || [];
        state.diet.days[day].meals[mealName].push(item);
        store.set(state);
        toast('Refeição adicionada','success');
        renderDieta();
      }
    });
  }

  /* =========================
     Finanças Page
     - CRUD entries, totals, charts
     ========================= */
  function renderFinancas(){
    const p = q('#page'); p.innerHTML=''; p.style.gridTemplateColumns='repeat(auto-fit,minmax(240px,1fr))';
    const s = store.get();
    const header = document.createElement('div'); header.className='glass';
    header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 style="margin:0">Finanças</h3><div class="small muted">Entradas e saídas</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn primary" id="add-entry">+ Lançamento</button>
        <select id="filter-month" class="input"><option value="">Mês atual</option></select>
      </div>
    </div>`;
    p.appendChild(header);

    const summary = document.createElement('div'); summary.className='glass';
    // calculate summary
    const nowDate = new Date();
    const monthEntries = s.finance.entries.filter(e => new Date(e.date).getMonth() === nowDate.getMonth() && new Date(e.date).getFullYear() === nowDate.getFullYear());
    const income = monthEntries.filter(e=>e.type==='receita').reduce((a,b)=>a+b.amount,0);
    const expenses = monthEntries.filter(e=>e.type==='despesa').reduce((a,b)=>a+b.amount,0);
    summary.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small muted">Receita</div><div style="font-weight:700;color:var(--success)">R$ ${income.toFixed(2)}</div>
      </div>
      <div>
        <div class="small muted">Despesa</div><div style="font-weight:700;color:var(--danger)">R$ ${expenses.toFixed(2)}</div>
      </div>
      <div>
        <div class="small muted">Saldo</div><div style="font-weight:700">${(income-expenses).toFixed(2)}</div>
      </div>
    </div>`;
    p.appendChild(summary);

    const listCard = document.createElement('div'); listCard.className='glass';
    listCard.innerHTML = `<h4 style="margin:0">Lançamentos</h4><div class="small muted">${s.finance.entries.length} registros</div>`;
    const list = document.createElement('div'); list.style.marginTop='12px'; list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px';
    s.finance.entries.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(e=>{
      const el = document.createElement('div'); el.className='glass';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${e.category}</strong><div class="small muted">${e.note||''}</div></div>
        <div style="text-align:right">
          <div style="font-weight:700">${e.type==='receita'?'+':'-'} R$ ${e.amount.toFixed(2)}</div>
          <div class="small muted">${e.date} • ${e.account||''}</div>
          <div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end">
            <button class="btn" data-action="edit">✎</button>
            <button class="btn" data-action="del">🗑️</button>
          </div>
        </div>
      </div>`;
      el.querySelector('[data-action="edit"]').addEventListener('click', ()=> openFinanceModal(e));
      el.querySelector('[data-action="del"]').addEventListener('click', ()=> {
        if(confirm('Excluir lançamento?')){
          const state = store.get(); state.finance.entries = state.finance.entries.filter(x=>x.id!==e.id); store.set(state); renderFinancas(); toast('Lançamento excluído','success');
        }
      });
      list.appendChild(el);
    });
    listCard.appendChild(list);
    p.appendChild(listCard);

    // charts card
    const charts = document.createElement('div'); charts.className='glass'; charts.innerHTML = `<canvas id="chart-fin" height="120"></canvas><div class="small muted">Receita vs Despesa (mês)</div>`;
    p.appendChild(charts);

    // render finance chart
    try{
      if(window.Chart){
        if(window.__chartFin) window.__chartFin.destroy();
        const ctx = q('#chart-fin').getContext('2d');
        const labels = ['Receita','Despesa'];
        const vals = [
          monthEntries.filter(e=>e.type==='receita').reduce((a,b)=>a+b.amount,0),
          monthEntries.filter(e=>e.type==='despesa').reduce((a,b)=>a+b.amount,0)
        ];
        window.__chartFin = new Chart(ctx, {type:'bar', data:{labels, datasets:[{data:vals, backgroundColor:['#34D399','#EF4444']}]}, options:{plugins:{legend:{display:false}}}});
      } else {
        q('#chart-fin').parentElement.innerHTML = `<div class="empty">Gráficos indisponíveis</div>`;
      }
    }catch(e){ console.error(e) }

    q('#add-entry').addEventListener('click', ()=> openFinanceModal());
  }

  function openFinanceModal(entry){
    const isNew = !entry;
    const clone = entry ? JSON.parse(JSON.stringify(entry)) : {id:uid('f'), type:'despesa', category:'Alimentação', amount:0, date:new Date().toISOString().slice(0,10), account:'Conta Corrente', note:''};
    const content = document.createElement('div');
    content.innerHTML = `
      <div class="form-row">
        <div style="width:140px">
          <label class="label">Tipo</label>
          <select id="f-type" class="input">
            <option ${clone.type==='despesa'?'selected':''}>despesa</option>
            <option ${clone.type==='receita'?'selected':''}>receita</option>
          </select>
        </div>
        <div style="flex:1"><label class="label">Categoria</label><input id="f-cat" class="input" value="${escapeHtml(clone.category||'')}"/></div>
        <div style="width:140px"><label class="label">Valor</label><input id="f-amount" type="number" class="input" value="${clone.amount||0}"/></div>
      </div>
      <div style="margin-top:8px" class="form-row">
        <div style="width:160px"><label class="label">Data</label><input id="f-date" type="date" class="input" value="${clone.date||''}" /></div>
        <div style="flex:1"><label class="label">Conta</label><input id="f-account" class="input" value="${escapeHtml(clone.account||'')}" /></div>
      </div>
      <div style="margin-top:8px">
        <label class="label">Nota</label><textarea id="f-note" class="input">${escapeHtml(clone.note||'')}</textarea>
      </div>
    `;
    const modal = openModal({title:isNew?'Novo lançamento':'Editar lançamento', content, ariaLabel:'Lançamento', onSave: ()=>{
      clone.type = q('#f-type',content).value;
      clone.category = q('#f-cat',content).value.trim() || 'Sem categoria';
      clone.amount = Number(q('#f-amount',content).value || 0);
      if(clone.amount <= 0) { toast('Valor deve ser maior que 0','warning'); return; }
      clone.date = q('#f-date',content).value || new Date().toISOString().slice(0,10);
      clone.account = q('#f-account',content).value || 'Conta Corrente';
      clone.note = q('#f-note',content).value;
      const state = store.get();
      if(isNew) state.finance.entries.push(clone);
      else {
        const idx = state.finance.entries.findIndex(x=>x.id===clone.id);
        if(idx>=0) state.finance.entries[idx] = clone;
      }
      store.set(state);
      toast('Lançamento salvo','success');
      renderFinancas();
    }});

    modal.modal.addEventListener('modal:delete', ()=> {
      if(!isNew && confirm('Excluir lançamento?')){
        const state = store.get(); state.finance.entries = state.finance.entries.filter(x=>x.id!==clone.id); store.set(state); modal.close(); renderFinancas(); toast('Excluído','success');
      }
    });
  }

  /* =========================
     Import / Export / Reset
     ========================= */
  function initImportExport(){
    q('#btn-export').addEventListener('click', ()=> {
      const data = store.get();
      downloadJSON('secondBrain-backup.json', data);
    });

    q('#btn-import').addEventListener('click', ()=> q('#file-input').click());
    q('#file-input').addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const parsed = JSON.parse(ev.target.result);
          // basic validation
          if(!parsed || !parsed.meta) throw new Error('Arquivo inválido (schema)');
          // confirm overwrite
          if(confirm('Importar substituirá seus dados atuais. Continuar?')){
            store.set(parsed);
            toast('Importação concluída', 'success');
            renderRoute();
          }
        }catch(err){
          toast('Erro importando: '+err.message,'danger');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    q('#btn-reset').addEventListener('click', ()=> {
      if(confirm('Resetar para dados de fábrica? Isso irá apagar os dados atuais.')){
        store.resetToFactory();
        renderRoute();
      }
    });
  }

  /* =========================
     Theme toggle & settings
     ========================= */
  function initSettings(){
    const btn = q('#btn-toggle-theme');
    btn.addEventListener('click', ()=> {
      const state = store.get();
      state.config.theme = state.config.theme === 'dark' ? 'light' : 'dark';
      store.set(state);
      btn.setAttribute('aria-pressed', state.config.theme === 'light');
      applyTheme(state.config.theme);
    });
    // apply initial theme
    const state = store.get();
    applyTheme(state.config?.theme || 'dark');
  }
  function applyTheme(theme){
    if(theme==='light'){
      document.documentElement.style.setProperty('--bg-1','#f6f7fb');
      document.documentElement.style.setProperty('--bg-2','#eef2ff');
      document.documentElement.style.setProperty('--glass-card','rgba(255,255,255,0.66)');
      document.documentElement.style.setProperty('--glass-border','rgba(0,0,0,0.06)');
      document.documentElement.style.setProperty('--text','rgba(12,12,12,0.9)');
      document.documentElement.style.setProperty('--text-strong','rgba(12,12,12,0.98)');
      document.body.style.color = 'var(--text)';
    } else {
      // reset to defaults by reloading CSS variables (we defined them in :root)
      document.documentElement.style.removeProperty('--bg-1');
      document.documentElement.style.removeProperty('--bg-2');
      document.documentElement.style.removeProperty('--glass-card');
      document.documentElement.style.removeProperty('--glass-border');
      document.documentElement.style.removeProperty('--text');
      document.documentElement.style.removeProperty('--text-strong');
    }
  }

  /* =========================
     Router dispatcher
     ========================= */
  function renderRoute(){
    highlightActiveTab();
    const route = getRoute();
    // lazy render only active page
    try{
      if(route.id === 'dashboard') renderDashboard();
      else if(route.id === 'estudos') renderEstudos();
      else if(route.id === 'planejamento') renderPlanejamento();
      else if(route.id === 'dieta') renderDieta();
      else if(route.id === 'financas') renderFinancas();
      // set focus to main for keyboard nav
      q('#main').focus();
    }catch(e){
      console.error('Render route failed', e);
      toast('Erro renderizando página: '+e.message,'danger');
    }
  }

  /* =========================
     Helpers & small utils
     ========================= */
  function escapeHtml(s=''){
    return s.replace?.(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') ?? s;
  }

  /* =========================
     Init app
     ========================= */
  function init(){
    // load store from localStorage (migrations handled in store.load)
    store.load();

    // render navigation
    renderNav();

    // wire import/export/reset
    initImportExport();

    // settings
    initSettings();

    // initial route
    if(!location.hash) location.hash = '#/dashboard';
    renderRoute();

    // subscribe to store changes to re-render current page when data changes
    store.subscribe(()=> {
      // lazy update: rerender active page
      renderRoute();
    });

    // keyboard accessibility: tab navigation, esc handled in modal
    document.addEventListener('keydown', (e)=>{
      // long-press shortcuts (simple)
      if(e.key === '1' && (e.ctrlKey||e.metaKey)){ navigate('#/dashboard'); e.preventDefault(); }
      if(e.key === '2' && (e.ctrlKey||e.metaKey)){ navigate('#/estudos'); e.preventDefault(); }
    });

    // performance: throttle resize re-layout affects
    let lastResize = 0;
    window.addEventListener('resize', ()=> {
      const t = now();
      if(t - lastResize > 200){
        lastResize = t;
        // could reflow grids if needed
      }
    });

    // load Chart.js dynamically (best effort)
    loadChartJs();
  }

  // dynamic Chart.js injection with fallback
  function loadChartJs(){
    if(window.Chart) return;
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = ()=> { toast('Chart.js carregado', 'success'); renderRoute(); };
    script.onerror = ()=> { toast('⚠️ Chart.js indisponível — gráficos serão omitidos', 'warning'); };
    document.head.appendChild(script);
  }

  // expose some modals to global for quick actions
  window.openTaskModal = openTaskModal;
  window.openMealModal = openMealModal;
  window.openFinanceModal = openFinanceModal;
  window.openStudyModal = openStudyModal;

  // start
  init();

  // expose store for debugging safely
  window.__SB = { store };

})();
</script>

<!-- Short documentation -->
<script>
/*
  Documentação curta:
  - Arquivo único index.html contém toda a aplicação SPA.
  - Onde alterar paleta: :root tokens no início do <style>.
  - Schemas: ver variável `schema` no script (studies, tasks, diet, finance, config).
  - Adicionar campos: adaptar as funções openStudyModal/openTaskModal/openMealItemModal/openFinanceModal e salvar no store.
  - Persistência: localStorage com chave 'secondBrain.v1'. Para reset, clique em Reset.
  - Import/Export: botões no header (JSON). Import substitui os dados atuais (confirmação).
  - Roteamento: hash-based (#/dashboard, #/estudos, #/planejamento, #/dieta, #/financas).
  - Gráficos: usam Chart.js via CDN; se não carregar, o app continua funcionando sem gráficos.
  - Acessibilidade: modais com role=dialog, foco inicial, Esc fecha. Tablists e ARIA labels nos navs.
  - Testes: recomendado abrir em 375x812 (mobile), 768x1024 (tablet), 1440x900 (desktop).
*/
</script>
</body>
</html>
